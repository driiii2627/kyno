{"version":3,"sources":["../../../../src/app/auth/actions.ts","../../../../.next-internal/server/app/login/%5Bcode%5D/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["'use server';\r\n\r\nimport { createServerClient, type CookieOptions } from '@supabase/ssr';\r\nimport { cookies, headers } from 'next/headers';\r\nimport { redirect } from 'next/navigation';\r\n\r\nconst ALLOWED_DOMAINS = ['gmail.com', 'outlook.com', 'hotmail.com', 'live.com', 'yahoo.com', 'icloud.com', 'proton.me', 'protonmail.com'];\r\n\r\nfunction isEmailAllowed(email: string) {\r\n    const domain = email.split('@')[1]?.toLowerCase();\r\n    return ALLOWED_DOMAINS.includes(domain);\r\n}\r\n\r\nexport async function loginAction(formData: FormData) {\r\n    const email = String(formData.get('email'));\r\n    const password = String(formData.get('password'));\r\n    const code = String(formData.get('code'));\r\n    const turnstileToken = String(formData.get('cf-turnstile-response'));\r\n\r\n    const headerList = await headers();\r\n    const ip = headerList.get('x-forwarded-for') || '127.0.0.1';\r\n\r\n    // 0. Rate Limit Check (4 attempts, 2 minutes block)\r\n    const cookieStore = await cookies();\r\n    const supabase = createServerClient(\r\n        process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n        {\r\n            cookies: {\r\n                getAll() { return cookieStore.getAll(); },\r\n                setAll(cookiesToSet) {\r\n                    try {\r\n                        cookiesToSet.forEach(({ name, value, options }) =>\r\n                            cookieStore.set(name, value, options)\r\n                        );\r\n                    } catch { }\r\n                },\r\n            },\r\n        }\r\n    );\r\n\r\n    const { data: limitData, error: limitError } = await supabase.rpc('check_and_update_rate_limit', {\r\n        request_ip: ip,\r\n        request_email: email,\r\n        request_type: 'login',\r\n        max_attempts: 4,\r\n        block_duration_seconds: 120\r\n    });\r\n\r\n    if (limitData && !limitData.allowed) {\r\n        return {\r\n            error: 'Muitas tentativas falhas. Tente novamente mais tarde.',\r\n            blockedUntil: limitData.blocked_until\r\n        };\r\n    }\r\n\r\n    // 1. Verify Cloudflare Turnstile\r\n    const secretKey = process.env.TURNSTILE_SECRET_KEY;\r\n    if (!secretKey) return { error: 'Configuração de servidor inválida.' };\r\n\r\n    const verifyRes = await fetch('https://challenges.cloudflare.com/turnstile/v0/siteverify', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n            secret: secretKey,\r\n            response: turnstileToken,\r\n            remoteip: ip,\r\n        }),\r\n    });\r\n\r\n    const verifyJson = await verifyRes.json();\r\n    if (!verifyJson.success) {\r\n        return { error: 'Falha na verificação de segurança (Captcha).' };\r\n    }\r\n\r\n    // 2. Validate Credentials\r\n    const { error } = await supabase.auth.signInWithPassword({\r\n        email,\r\n        password,\r\n    });\r\n\r\n    if (error) {\r\n        console.error('Login Error:', error.message);\r\n        return { error: error.message };\r\n    }\r\n\r\n    // Success: Reset rate limit\r\n    await supabase.rpc('reset_rate_limit', {\r\n        request_ip: ip,\r\n        request_type: 'login'\r\n    });\r\n\r\n    return { success: true };\r\n}\r\n\r\nexport async function registerAction(formData: FormData) {\r\n    const email = String(formData.get('email'));\r\n    const password = String(formData.get('password'));\r\n    const code = String(formData.get('code'));\r\n    const turnstileToken = String(formData.get('cf-turnstile-response'));\r\n\r\n    if (!isEmailAllowed(email)) {\r\n        return { error: 'Domínio de e-mail não permitido. Use Gmail, Outlook, Yahoo, etc.' };\r\n    }\r\n\r\n    const headerList = await headers();\r\n    const ip = headerList.get('x-forwarded-for') || '127.0.0.1';\r\n\r\n    // 0. Rate Limit Check (9 attempts, 2 minutes block)\r\n    const cookieStore = await cookies();\r\n    const supabase = createServerClient(\r\n        process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n        {\r\n            cookies: {\r\n                getAll() { return cookieStore.getAll(); },\r\n                setAll(cookiesToSet) {\r\n                    try {\r\n                        cookiesToSet.forEach(({ name, value, options }) =>\r\n                            cookieStore.set(name, value, options)\r\n                        );\r\n                    } catch { }\r\n                },\r\n            },\r\n        }\r\n    );\r\n\r\n    const { data: limitData } = await supabase.rpc('check_and_update_rate_limit', {\r\n        request_ip: ip,\r\n        request_email: email,\r\n        request_type: 'register',\r\n        max_attempts: 9,\r\n        block_duration_seconds: 120\r\n    });\r\n\r\n    if (limitData && !limitData.allowed) {\r\n        return {\r\n            error: 'Muitas tentativas de cadastro. Aguarde um momento.',\r\n            blockedUntil: limitData.blocked_until\r\n        };\r\n    }\r\n\r\n    // 1. Verify Cloudflare Turnstile\r\n    const secretKey = process.env.TURNSTILE_SECRET_KEY;\r\n    if (!secretKey) return { error: 'Configuração de servidor inválida.' };\r\n\r\n    const verifyRes = await fetch('https://challenges.cloudflare.com/turnstile/v0/siteverify', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n            secret: secretKey,\r\n            response: turnstileToken,\r\n            remoteip: ip,\r\n        }),\r\n    });\r\n\r\n    const verifyJson = await verifyRes.json();\r\n    if (!verifyJson.success) {\r\n        return { error: 'Falha na verificação de segurança (Captcha).' };\r\n    }\r\n\r\n    // 2. Check IP Limit && Create Account\r\n    const { data: isAllowed } = await supabase.rpc('check_ip_registration_rate_limit', {\r\n        request_ip: ip\r\n    });\r\n\r\n    if (isAllowed === false) {\r\n        return { error: 'Limite de contas atingido para este dispositivo.' };\r\n    }\r\n\r\n    // 3. Create Account\r\n    let authData: { user: any; session: any } = { user: null, session: null };\r\n    let authError: any = null;\r\n\r\n    const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\n\r\n    if (serviceRoleKey) {\r\n        // Use Admin API to bypass email confirmation\r\n        const { createClient } = await import('@supabase/supabase-js');\r\n        const supabaseAdmin = createClient(\r\n            process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n            serviceRoleKey,\r\n            {\r\n                auth: {\r\n                    autoRefreshToken: false,\r\n                    persistSession: false\r\n                }\r\n            }\r\n        );\r\n\r\n        const { data: userData, error: createError } = await supabaseAdmin.auth.admin.createUser({\r\n            email,\r\n            password,\r\n            email_confirm: true\r\n        });\r\n\r\n        if (createError) {\r\n            authError = createError;\r\n        } else if (userData.user) {\r\n            authData.user = userData.user;\r\n            // Now sign in to create the session for the user\r\n            const { data: signInData, error: signInError } = await supabase.auth.signInWithPassword({\r\n                email,\r\n                password\r\n            });\r\n\r\n            if (signInError) {\r\n                console.error(\"Auto-login failed after admin creation\", signInError);\r\n            } else {\r\n                authData.session = signInData.session;\r\n            }\r\n        }\r\n    } else {\r\n        // Fallback to standard flow\r\n        const { data, error } = await supabase.auth.signUp({\r\n            email,\r\n            password,\r\n        });\r\n        authData = data;\r\n        authError = error;\r\n    }\r\n\r\n    if (authError) {\r\n        return { error: authError.message };\r\n    }\r\n\r\n    if (authData.user) {\r\n        // Log access\r\n        await supabase.from('kyno_user_security_logs').insert({\r\n            user_id: authData.user.id,\r\n            unique_login_code: code,\r\n            registration_ip: ip,\r\n            last_ip: ip\r\n        });\r\n\r\n        // Reset rate limit on success\r\n        await supabase.rpc('reset_rate_limit', {\r\n            request_ip: ip,\r\n            request_type: 'register'\r\n        });\r\n    }\r\n\r\n    if (authData.session) {\r\n        return { success: true, autoLogin: true };\r\n    }\r\n\r\n    return { success: true, autoLogin: false };\r\n}\r\n","export {getProfilesAction as '0018c6db43529b3ca9c55f1a4bb647fb8415811d1d'} from 'ACTIONS_MODULE0'\nexport {createProfileAction as '407fa483aadb683ffaf8d267be44a2d4010bfbd905'} from 'ACTIONS_MODULE0'\nexport {updateProfileAction as '40c7e6cc5ffa74f4aaa5de5b158ce112ad5e6af404'} from 'ACTIONS_MODULE0'\nexport {deleteProfileAction as '40fc0c27050575de9cc323afb67bce1d8322753d08'} from 'ACTIONS_MODULE0'\nexport {switchProfileAction as '4009cb87dbf8261408287db81f95ca338a80372201'} from 'ACTIONS_MODULE0'\nexport {signOutAction as '00044a13b912e98127fb87132cc89613aabacf9b57'} from 'ACTIONS_MODULE0'\nexport {getActiveProfileAction as '0056cb79b9ec21b37d317dc696b43a5f5c326ae982'} from 'ACTIONS_MODULE0'\nexport {loginAction as '400082d863ec6ec9b9313eab5cc4d39f428d8ee165'} from 'ACTIONS_MODULE1'\nexport {registerAction as '405f1d1ebcdca18c23098ba1f418289facfb43d571'} from 'ACTIONS_MODULE1'\n"],"names":[],"mappings":"uDAEA,EAAA,CAAA,CAAA,OAAA,IAAA,EAAA,EAAA,CAAA,CAAA,MACA,EAAA,EAAA,CAAA,CAAA,mBAGA,IAAM,EAAkB,CAAC,YAAa,cAAe,cAAe,WAAY,YAAa,aAAc,YAAa,iBAAiB,CAOlI,eAAe,EAAY,CAAkB,EAChD,IAAM,EAAQ,OAAO,EAAS,GAAG,CAAC,UAC5B,EAAW,OAAO,EAAS,GAAG,CAAC,aACxB,OAAO,EAAS,GAAG,CAAC,SACjC,IAAM,EAAiB,OAAO,EAAS,GAAG,CAAC,0BAGrC,EAAK,CADQ,MAAM,CAAA,EAAA,EAAA,OAAA,AAAO,GAAA,EACV,GAAG,CAAC,oBAAsB,YAG1C,EAAc,MAAM,CAAA,EAAA,EAAA,OAAA,AAAO,IAC3B,EAAW,CAAA,EAAA,EAAA,kBAAA,AAAkB,EAC/B,QAAQ,GAAG,CAAC,wBAAwB,CACpC,QAAQ,GAAG,CAAC,6BAA6B,CACzC,CACI,QAAS,QACL,IAAkB,EAAY,MAAM,GACpC,OAAO,CAAY,EACf,GAAI,CACA,EAAa,OAAO,CAAC,CAAC,MAAE,CAAI,OAAE,CAAK,CAAE,SAAO,CAAE,GAC1C,EAAY,GAAG,CAAC,EAAM,EAAO,GAErC,CAAE,KAAM,CAAE,CACd,CACJ,CACJ,GAGE,CAAE,KAAM,CAAS,CAAE,MAAO,CAAU,CAAE,CAAG,MAAM,EAAS,GAAG,CAAC,8BAA+B,CAC7F,WAAY,EACZ,cAAe,EACf,aAAc,QACd,aAAc,EACd,uBAAwB,GAC5B,GAEA,GAAI,GAAa,CAAC,EAAU,OAAO,CAC/B,CADiC,KAC1B,CACH,MAAO,wDACP,aAAc,EAAU,aAAa,AACzC,EAIJ,IAAM,EAAY,QAAQ,GAAG,CAAC,oBAAoB,CAClD,GAAI,CAAC,EAAW,MAAO,CAAE,MAAO,oCAAqC,EAErE,IAAM,EAAY,MAAM,MAAM,4DAA6D,CACvF,OAAQ,OACR,QAAS,CAAE,eAAgB,kBAAmB,EAC9C,KAAM,KAAK,SAAS,CAAC,CACjB,OAAQ,EACR,SAAU,EACV,SAAU,CACd,EACJ,GAGA,GAAI,CAAC,CADc,MAAM,EAAU,IAAI,EAAA,EACvB,OAAO,CACnB,CADqB,KACd,CAAE,MAAO,8CAA+C,EAInE,GAAM,OAAE,CAAK,CAAE,CAAG,MAAM,EAAS,IAAI,CAAC,kBAAkB,CAAC,OACrD,WACA,CACJ,UAEA,AAAI,GACA,IADO,IACC,KAAK,CAAC,eAAgB,EAAM,OAAO,EACpC,CAAE,MAAO,EAAM,OAAO,AAAC,IAIlC,MAAM,EAAS,GAAG,CAAC,mBAAoB,CACnC,WAAY,EACZ,aAAc,OAClB,GAEO,CAAE,SAAS,CAAK,EAC3B,CAEO,eAAe,EAAe,CAAkB,EACnD,MAAM,EAAQ,OAAO,EAAS,GAAG,CAAC,UAC5B,EAAW,OAAO,EAAS,GAAG,CAAC,aAC/B,EAAO,OAAO,EAAS,GAAG,CAAC,SAC3B,EAAiB,OAAO,EAAS,GAAG,CAAC,0BAE3C,GA5FM,CA4FF,CA5FW,AA4FV,AAAe,EA5FC,KAAK,CAAC,AA4FC,IA5FG,CAAC,EAAE,EAAE,eAC7B,EAAgB,QAAQ,CAAC,GA4F5B,MAAO,CAAE,MAAO,kEAAmE,EAIvF,IAAM,EAAK,CADQ,MAAM,CAAA,EAAA,EAAA,OAAO,AAAP,GAAO,EACV,GAAG,CAAC,oBAAsB,YAG1C,EAAc,MAAM,CAAA,EAAA,EAAA,OAAA,AAAO,IAC3B,EAAW,CAAA,EAAA,EAAA,kBAAA,AAAkB,EAC/B,QAAQ,GAAG,CAAC,wBAAwB,CACpC,QAAQ,GAAG,CAAC,6BAA6B,CACzC,CACI,QAAS,CACL,WAAkB,EAAY,MAAM,GACpC,OAAO,CAAY,EACf,GAAI,CACA,EAAa,OAAO,CAAC,CAAC,MAAE,CAAI,OAAE,CAAK,SAAE,CAAO,CAAE,GAC1C,EAAY,GAAG,CAAC,EAAM,EAAO,GAErC,CAAE,KAAM,CAAE,CACd,CACJ,CACJ,GAGE,CAAE,KAAM,CAAS,CAAE,CAAG,MAAM,EAAS,GAAG,CAAC,8BAA+B,CAC1E,WAAY,EACZ,cAAe,EACf,aAAc,WACd,aAAc,EACd,uBAAwB,GAC5B,GAEA,GAAI,GAAa,CAAC,EAAU,OAAO,CAC/B,CADiC,KAC1B,CACH,MAAO,qDACP,aAAc,EAAU,aAAa,AACzC,EAIJ,IAAM,EAAY,QAAQ,GAAG,CAAC,oBAAoB,CAClD,GAAI,CAAC,EAAW,MAAO,CAAE,MAAO,oCAAqC,EAErE,IAAM,EAAY,MAAM,MAAM,4DAA6D,CACvF,OAAQ,OACR,QAAS,CAAE,eAAgB,kBAAmB,EAC9C,KAAM,KAAK,SAAS,CAAC,CACjB,OAAQ,EACR,SAAU,EACV,SAAU,CACd,EACJ,GAGA,GAAI,CAAC,CADc,MAAM,EAAU,IAAI,EAAA,EACvB,OAAO,CACnB,CADqB,KACd,CAAE,MAAO,8CAA+C,EAInE,GAAM,CAAE,KAAM,CAAS,CAAE,CAAG,MAAM,EAAS,GAAG,CAAC,mCAAoC,CAC/E,WAAY,CAChB,GAEA,IAAkB,IAAd,EACA,CADqB,KACd,CAAE,MAAO,kDAAmD,EAIvE,IAAI,EAAwC,CAAE,KAAM,KAAM,QAAS,IAAK,EACpE,EAAiB,KAEf,EAAiB,QAAQ,GAAG,CAAC,yBAAyB,CAE5D,GAAI,EAAgB,CAEhB,GAAM,cAAE,CAAY,CAAE,CAAG,MAAA,EAAA,CAAA,CAAA,OACnB,EAAgB,EAClB,QAAQ,GAAG,CAAC,wBAAwB,CACpC,EACA,CACI,KAAM,CACF,kBAAkB,EAClB,gBAAgB,CACpB,CACJ,GAGE,CAAE,KAAM,CAAQ,CAAE,MAAO,CAAW,CAAE,CAAG,MAAM,EAAc,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,OACrF,WACA,EACA,eAAe,CACnB,GAEA,GAAI,EACA,EAAY,OACT,EAFU,CAEN,EAAS,IAAI,CAAE,CACtB,EAAS,IAAI,CAAG,EAAS,IAAI,CAE7B,GAAM,CAAE,KAAM,CAAU,CAAE,MAAO,CAAW,CAAE,CAAG,MAAM,EAAS,IAAI,CAAC,kBAAkB,CAAC,OACpF,WACA,CACJ,GAEI,EACA,QAAQ,GADK,EACA,CAAC,yCAA0C,GAExD,EAAS,OAAO,CAAG,EAAW,OAAO,AAE7C,CACJ,KAAO,CAEH,GAAM,MAAE,CAAI,OAAE,CAAK,CAAE,CAAG,MAAM,EAAS,IAAI,CAAC,MAAM,CAAC,OAC/C,EACA,UACJ,GACA,EAAW,EACX,EAAY,CAChB,QAEA,AAAI,EACO,CAAE,MAAO,EADL,AACe,OAAO,AAAC,GAGlC,EAAS,IAAI,EAAE,CAEf,MAAM,EAAS,IAAI,CAAC,2BAA2B,MAAM,CAAC,CAClD,QAAS,EAAS,IAAI,CAAC,EAAE,CACzB,kBAAmB,EACnB,gBAAiB,EACjB,QAAS,CACb,GAGA,MAAM,EAAS,GAAG,CAAC,mBAAoB,CACnC,WAAY,EACZ,aAAc,UAClB,IAGA,EAAS,OAAO,EAAE,AACX,CAAE,SAAS,EAAM,WAAW,CAAK,EAGrC,CAAE,SAAS,EAAM,WAAW,CAAM,CAC7C,iCA1OsB,EAkFA,IAlFA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAkFA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,gFC/FtB,IAAA,EAAA,EAAA,CAAA,CAAA,OAOA,EAAA,EAAA,CAAA,CAAA"}